<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EchoAI - Login</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Jura:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
    <script type="module" src="{{ url_for('static', filename='firebase_config.js') }}"></script>
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <h2 class="auth-title">Welcome Back</h2>
            <p class="auth-subtitle">Login to continue your journey</p>
            <form class="auth-form">
                <div class="input-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" placeholder="Enter your email" required>
                </div>
                <div class="input-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="auth-button">Login</button>
            </form>
            <div class="social-login">
                <button id="google-login-btn" class="google-button">
                    <img src="{{ url_for('static', filename='google_auth_icon.svg') }}" alt="Google Icon" class="google-icon">
                    Sign in with Google
                </button>
            </div>
            <p class="auth-footer">Don't have an account? <a href="/signup">Sign Up</a></p>
        </div>
    </div>
    <script type="module">
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { app } from "{{ url_for('static', filename='firebase_config.js') }}";

        document.addEventListener('DOMContentLoaded', () => {
            const auth = getAuth(app);
            const provider = new GoogleAuthProvider();

            const googleButton = document.getElementById('google-login-btn');
            if (googleButton) {
                googleButton.addEventListener('click', async () => {
                    try {
                        const result = await signInWithPopup(auth, provider);
                        const idToken = await result.user.getIdToken();

                        // Send ID token to Flask backend for session login
                        const response = await fetch('/sessionLogin', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ idToken: idToken }),
                        });

                        if (response.ok) {
                            window.location.href = '/chat'; // Redirect to chat page on successful login
                        } else {
                            const errorData = await response.json();
                            alert(`Backend login failed: ${errorData.error}`);
                        }
                    } catch (error) {
                        console.error("Error during Google Sign-In or backend login:", error);
                        alert(`Google Sign-In failed: ${error.message}`);
                    }
                });
            }

            // Logout function (can be triggered from another page or element)
            async function logout() {
                try {
                    await signOut(auth);
                    const response = await fetch('/sessionLogout', {
                        method: 'POST',
                    });

                    if (response.ok) {
                        window.location.href = '/login'; // Redirect to login page on successful logout
                    } else {
                        const errorData = await response.json();
                        alert(`Backend logout failed: ${errorData.error}`);
                    }
                } catch (error) {
                    console.error("Error during logout:", error);
                    alert(`Logout failed: ${error.message}`);
                }
            }

            // Expose logout to global scope for easy access from other parts of the application if needed
            window.logout = logout;
        });
    </script>
</body>
</html>